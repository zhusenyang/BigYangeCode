<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script src="../js/config.js"></script>
    <script src="../layui/layui.js"></script>
    <title>个人中心</title>
    <link rel="stylesheet" href="../layui/css/layui.css">
    <script type="text/javascript" src="../js/jquery.js"></script>
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
    <div class="layui-header">
        <div class="layui-logo">个人中心</div>
        <!-- 头部区域（可配合layui已有的水平导航） -->
        <ul class="layui-nav layui-layout-left">
        </ul>
        <ul class="layui-nav layui-layout-right">
            <li class="layui-nav-item"><a href="javascript:;">
                <img class="layui-nav-img" id="user_head_top">
                <span id="top_name"></span>
            </a>
                <dl class="layui-nav-child">
                    <dd>
                        <a href="javascrpt:;">基本资料</a>
                    </dd>
                    <dd>
                        <a href="">安全设置</a>
                    </dd>
                </dl></li>
            <li class="layui-nav-item">
                <a href="javascript:;" onclick="logOut()">登出</a>
            </li>
        </ul>
    </div>

    <div class="layui-side layui-bg-black">
        <div class="layui-side-scroll">
            <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
            <ul id="left_order" class="layui-nav layui-nav-tree" lay-filter="test">
                <li class="layui-nav-item layui-nav-itemed" id="center" onclick="modelChange(this)">
                    <a href="javascript:;" >基本资料</a>
                </li>
                <li class="layui-nav-item layui-nav-itemed" id="history" onclick="modelChange(this)">
                    <a href="javascript:;" >浏览记录</a>
                </li>
                <li class="layui-nav-item layui-nav-itemed" id="like" onclick="modelChange(this)">
                    <a href="javascript:;" >收藏</a>
                </li>
                <li class="layui-nav-item layui-nav-itemed" id="message" onclick="modelChange(this)">
                    <a href="javascript:;" >消息</a>
                </li>
                <li class="layui-nav-item layui-nav-itemed" id="save_center" onclick="modelChange(this)">
                    <a href="javascript:;">安全中心</a>
                </li>
            </ul>
        </div>
    </div>
    <div class="layui-body">
        <!-- 内容主体区域 -->
        <div style="padding: 0px;">
            <!-- 个人中心-->
            <div class="model" id="center_model" style="">
                <div class="layui-tab">
                    <ul class="layui-tab-title">
                        <li class="layui-this">基本资料</li>
                    </ul>
                    <div class="layui-tab-content">
                        <div class="layui-tab-item layui-show">
                            <span id="user_id" hidden="hidden"></span>
                            <form class="layui-form layui-col-sm7" action="" lay-filter="user-info-form" >
                                <div class="layui-form-item">
                                    <label class="layui-form-label" >用户名</label>
                                    <div class="layui-input-inline">
                                        <input id="user-name" style="background-color: #FBFBFB" autocomplete="off" class="layui-input disabled layui-btn-disabled" name="userName" disabled="disabled" >
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">昵称</label>
                                    <div class="layui-input-inline">
                                        <input id="nicoName-info" autocomplete="off" class="layui-input" name="nicoName">
                                    </div>


                                    <div class="layui-form-mid layui-word-aux"></div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">性别</label>
                                    <div class="layui-input-block sex_choose">
                                        <input id="man" type="radio" name="sex" value="man" title="男♂">
                                        <input id="women" type="radio" name="sex" value="woman" title="女♀" >
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">地区</label>
                                    <div class="layui-input-inline">
                                        <input id="user-area" autocomplete="off" class="layui-input" name="user-area">
                                    </div>
                                    <div class="layui-form-mid layui-word-aux"></div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">邮箱</label>
                                    <div class="layui-input-inline">
                                        <input id="eMail" style="background-color: #FBFBFB" disabled="disabled" autocomplete="off" class="layui-btn-disabled layui-input" name="user-area">
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">入站日期</label>
                                    <div class="layui-input-inline ">
                                        <input id="registered_Date"  style="background-color: #FBFBFB" disabled="disabled" autocomplete="off" class="layui-btn-disabled layui-input" name="registered_Date">
                                    </div>
                                </div>
                                <div class="layui-form-item layui-form-text">
                                    <label class="layui-form-label">个人简介</label>
                                    <div class="layui-input-block">
                                        <textarea id="introduction" name="introduction" placeholder="请输入内容" class="layui-textarea"></textarea>
                                    </div>
                                </div>
                            </form>
                            <div class="layui-form layui-col-sm3">
                                <div class="row">
                                    <label class="layui-form-label" >头像</label></tr>
                                    <div class="example col-xs-12 col-md-12"
                                         style="margin-left: 15px;">
                                        <p>
                                            <img class="img-rounded" style="height: 200px;width: 200px;" alt=""
                                                  id="form_head">
                                        </p>
                                    </div>
                                    <button type="button" class="layui-btn" id="head_upload">
                                        <i class="layui-icon">&#xe67c;</i>更换头像
                                    </button>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <div class="layui-input-block">
                                    <button class="layui-btn" id="user_center_save"  onclick="saveUserCenter()">保存</button>
                                    <button class="layui-btn layui-btn-primary" onclick="reset()">重置</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 浏览记录-->
            <div class="model" id="history_model"  style="">
                <div class="layui-tab">
                    <ul class="layui-tab-title">
                        <li class="layui-this">浏览记录</li>
                    </ul>
                    <div class="layui-tab-content">

                    </div>
                </div>
            </div>
            <!--     收藏       -->
            <div class="model" id="like_model"  style="">
                <div class="layui-tab">
                    <ul class="layui-tab-title">
                        <li class="layui-this">我的收藏</li>
                    </ul>
                    <div class="layui-tab-content">

                    </div>
                </div>
            </div>
            <!--     消息       -->
            <div class="model" id="message_model"  style="">
                <div class="layui-tab">
                    <ul class="layui-tab-title">
                        <li class="layui-this">回复</li>
                        <li >站内信</li>
                    </ul>
                    <div class="layui-tab-content">
                        <div class="layui-tab-item layui-show">回复</div>
                        <div class="layui-tab-item">站内信</div>
                    </div>
                </div>
            </div>
            <!--      安全中心      -->
            <div class="model"  id="save_center_model" style="">
                <div class="layui-tab">
                    <ul class="layui-tab-title">
                        <li class="layui-this">安全中心</li>
                    </ul>
                    <div class="layui-tab-content">

                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="layui-footer">
        <!-- 底部固定区域 -->
        <a href="http://bigyangcode.xyz" onload="chooseSex()">© - bigyangcode</a>
    </div>
</div>

</body>
</html >
<script type="text/javascript">
    var user ;
    var element;
    layui.use('element', function() {
        element = layui.element;
    });
    var layer
    var form
    var userId
    //初始化用户中心表单
    layui.use(['layer', 'form'], function(){
             layer = layui.layer;
             form = layui.form;
            //获取用户信息
            $.ajax({
                url: yu_ming+"/user/getInfo",
                type : "post",
                scriptCharset : 'utf-8',
                success: function(result){
                    if(result.stateNum==200){
                        var data = result.data;
                        user=data;
                        reset();
                        chooseSex()
                        initUpLoad()
                    }
                }
            });
    });
    var upload
    function initUpLoad(){
        layui.use('upload', function(){
            upload = layui.upload;
            //执行实例
            var uploadInst = upload.render({
                elem: '#head_upload' //绑定元素
                ,url: './userCenterSave' //上传接口
                ,data:{
                    id:userId,
                    userName:user.userName,
                    area:function () {
                        return $("#user-area").val()
                    },
                    introduction:function () {
                        return $("#introduction").val()
                    },
                    nicoName:function () {
                        return $("#nicoName-info").val()
                    },
                    sex:function () {
                       return form.val("user-info-form").sex
                    }
                }
                ,auto:false
                ,accept:"images"
                ,acceptMime : 'image/*'//只显示图片
                ,bindAction: "#user_center_save"
                ,size:"300"
                ,choose:function (obj){
                    //将每次选择的文件追加到文件队列
                    var files = obj.pushFile();
                    //预读本地文件，如果是多文件，则会遍历。(不支持ie8/9)
                    obj.preview(function(index, file, result) {
                        // console.log(index); //得到文件索引
                        // console.log(file); //得到文件对象
                        // console.log(result); //得到文件base64编码，比如图片
                        $("#form_head").attr("src",result);
                    })
                }
                ,done: function(res){
                    if(res.stateNum==200){
                        reloadUserInfo()
                    }
                    layer.msg(res.content)
                }
                ,error: function(){
                    //请求异常回调
                }
            });
        })
    }

    function reloadUserInfo(){
        $.ajax({
            url: yu_ming+"/user/getInfo",
            type : "post",
            scriptCharset : 'utf-8',
            success: function(result){
                if(result.stateNum==200){
                    var data = result.data;
                    user=data;
                    reset();
                    chooseSex()
                    initUpLoad()
                }
            }
        });
    }

    //更换性别
    function chooseSex(){
        var formDate = form.val("user-info-form");
        formDate.sex=$("input[name='sex'][value='man']").attr("checked", user.sex == "man" ? true : false)
        formDate.sex=$("input[name='sex'][value='woman']").attr("checked", user.sex == "woman" ? true : false)
        console.log(formDate)
        form.val(formDate)
        form.render();
    }

    //切换功能模式
    function modelChange(a){
       var models= $(".model")
        for (var i=0;i<models.length;i++){
            var id=$(models[i]).attr("id")
            if ($(a).attr("id")+"_model"==id){
                $(models[i]).removeAttr("hidden");
            } else {
                $(models[i]).attr("hidden","hidden")
            }
        }
    }

    //提交个人中心的更改
    function saveUserCenter(){
        console.log($("#form_head").attr("src").indexOf("base64"))
        if ($("#form_head").attr("src").indexOf("base64")>-1){
            return;
        }
         console.log(form.val("user-info-form"));
         $.ajax({
             url: yu_ming+"/user/userCenterSave",
             type : "post",
             scriptCharset : 'utf-8',
             data:{
                 id:userId,
                 userName:user.userName,
                 area:function () {
                     return $("#user-area").val()
                 },
                 introduction:function () {
                     return $("#introduction").val()
                 },
                 nicoName:function () {
                     return $("#nicoName-info").val()
                 },
                 sex:function () {
                     return form.val("user-info-form").sex
                 }
             },
             success: function(result){
                 if(result.stateNum==200){
                     reloadUserInfo()
                 }
                 layer.msg(result.content)
             }
         })
    }



    //登出
    function logOut(){
        $.ajax({
            url: yu_ming+"/user/logout",
            type : "post",
            scriptCharset : 'utf-8',
            success: function(result){
                if(result.stateNum==200){
                    layer.msg("退出成功,返回主页s.")
                    window.location.href=yu_ming;
                }
            }
        });
    }

    //初始化用户信息
    function reset(){
        userId=user.id;
        $("#user_id").text(user.id);
        $("#user-name").val(user.userName);
        if(user.nicoName==null){
            $("#nicoName-info").val(user.userName);
            $("#top_name").text(user.userName);
        }else {
            $("#nicoName-info").val(user.nicoName);
            $("#top_name").text(user.nicoName);
        }
        $("#introduction").val(user.introduction);
        $("#user_head_top").attr("src","../head/"+user.head)
        $("#form_head").attr("src","../head/"+user.head)
        $("#introduction").val(user.introduction);
        $("#user-area").val(user.area)
        $("#eMail").val(user.eMail)
        $("#registered_Date").val(user.registered_Date.split(" ")[0])

    }

    //init
    $(function () {
        var modelName =chooseCenterModel();
        var model=$("#"+modelName);
        var oldClass=model.attr("class");
        model.attr("class",oldClass+" layui-this");
        model.click();
    })
</script>
